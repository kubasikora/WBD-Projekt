from flask import Flask, Response, request
from flask_cors import CORS
import cx_Oracle
import json

app = Flask(__name__)
CORS(app)


@app.route('/')
def hello_world():
    con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
    print(con.version)
    return 'Hello World!<br>connection version: <br>' + con.version


@app.route('/incoming_matches')
def show_incoming_matches():
    con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
    cur = con.cursor()
    cur.execute(
        'select "MeczId", extract(year from m."DataRozpoczecia"), extract(month from m."DataRozpoczecia"), extract(day from m."DataRozpoczecia"), dh."Nazwa", da."Nazwa", st."Nazwa", ref."Imie", ref."Nazwisko", t."Nazwa", w."WynikGospodarzy", w."WynikGosci"  from "Mecze" m join "Druzyny" dh on dh."DruzynaId"=m."DruzynaGospodarzyId" join "Druzyny" da on da."DruzynaId"= m."DruzynaGosciId" join "Stadiony" st on st."StadionId" = m."StadionId" join "Sedziowie" ref on ref."SedziaId" = m."SedziaId" join "Turnieje" t on t."TurniejId" = m."TurniejId" join "Wyniki" w on w."WynikId" = m."WynikId" where m."WynikId" IS NULL')

    resp = cur.fetchmany(numRows=10)
    return Response(json.dumps(resp), mimetype='application/json')


@app.route('/finished_matches')
def show_finished_matches():
    # sqlQuery = 'select * from "Mecze" m join "Druzyny" dh on dh."DruzynaId"=m."DruzynaGospodarzyId" join "Druzyny" da on da."DruzynaId"= m."DruzynaGosciId" join "Stadiony" s on s."StadionId" = m."StadionId" join "Sedziowie" ref on ref."SedziaId" = m."SedziaId" join "Turnieje" t on t."TurniejId" = m."TurniejId" join "Wyniki" w on w."WynikId" = m."WynikId" where m."WynikId" IS NOT NULL;'

    con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
    cur = con.cursor()
    cur.execute('select "MeczId", extract(year from m."DataRozpoczecia"), extract(month from m."DataRozpoczecia"), extract(day from m."DataRozpoczecia"), dh."Nazwa", da."Nazwa", st."Nazwa", ref."Imie", ref."Nazwisko", t."Nazwa", w."WynikGospodarzy", w."WynikGosci"  from "Mecze" m join "Druzyny" dh on dh."DruzynaId"=m."DruzynaGospodarzyId" join "Druzyny" da on da."DruzynaId"= m."DruzynaGosciId" join "Stadiony" st on st."StadionId" = m."StadionId" join "Sedziowie" ref on ref."SedziaId" = m."SedziaId" join "Turnieje" t on t."TurniejId" = m."TurniejId" join "Wyniki" w on w."WynikId" = m."WynikId" where m."WynikId" IS NOT NULL')

    resp = cur.fetchmany(numRows=10)
    return Response(json.dumps(resp), mimetype='application/json')


@app.route('/sign_in')
def sign_in_operation():
    #ogin = "robart"
    #password = "robar123"
    try:
        login = request.args.get("login")
        password = request.args.get("password")
    except ValueError:
        resp = {
            "error": True,
            "message": "Invalid arguments"
        }

    con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
    cur = con.cursor()

    cur.execute('select "UzytkownikId", "Login", "Imie", "Nazwisko" from "Uzytkownicy" where "Login"=' + "'" + login + "'" + ' and "Haslo"=' + "'" + password + "'")

    resp = cur.fetchone()
    return Response(json.dumps(resp), mimetype='application/json')

@app.route("/tournaments_sign_up")#, methods=['POST'])
def sign_up_for_tournament():
    try:
        tournament = int(request.args.get("TurniejId"))
        user = int(request.args.get("UzytkownikId"))
        con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
        cur = con.cursor()

        statement = 'insert into "ZapisyUzytkownikow"("UzytkownikId", "TurniejId") values (:1, :2)'
        cur.execute(statement, (str(user), str(tournament)))
        con.commit()
        resp = 'ok'
    except ValueError:
        resp = {
            "error": True,
            "message": "Invalid arguments"
        }
    return Response(json.dumps(resp), mimetype='application/json')

@app.route('/tournament_list')
def show_available_tournaments():
    try:
        user = request.args.get("UzytkownikId")

        con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
        cur = con.cursor()

        cur.execute('select "TurniejId", "Nazwa", extract(year from "DataRozpoczecia"), extract(month from "DataRozpoczecia"), extract(day from "DataRozpoczecia") from "Turnieje" where "TurniejId" NOT IN (select "TurniejId" from "ZapisyUzytkownikow" where "UzytkownikId"=' + str(user) + ')')
        resp = cur.fetchall()
        print(cur.rowcount)
        #if cur.rowcount == 0:
            #cur.execute('select "TurniejId", "Nazwa", extract(year from "DataRozpoczecia"), extract(month from "DataRozpoczecia"), extract(day from "DataRozpoczecia") from "Turnieje"')
            #resp = cur.fetchall()

    except ValueError:
        resp = {
            "error": True,
            "message": "Invalid arguments"
        }
    return Response(json.dumps(resp), mimetype='application/json')

@app.route('/bets_list')
def show_available_bets():
    try:
        user = request.args.get("UzytkownikId")
        con = cx_Oracle.connect("rwojtas", "rwojtas", cx_Oracle.makedsn("194.29.160.131", 1521, "ora3inf"))
        cur = con.cursor()

        cur.execute('select * from ')
    except ValueError:
        resp = {
            "error": True,
            "message": "Invalid arguments"
        }
    return Response(json.dumps(resp), mimetype='application/json')

if __name__ == '__main__':
    app.run()
